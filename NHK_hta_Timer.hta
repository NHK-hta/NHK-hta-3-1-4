<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=Shift_JIS"> 

<title>NHK.hta Timer</title>
<!--				TOMURA Hiromi	-->

<script Language="VBScript">
<!--
Option Explicit   ' •Ï”‚É‘Î‚µ‚ÄA–¾¦“I‚ÈéŒ¾‚ğ‹­§‚µ‚Ü‚·B


'Window.ReSizeTo 270, 180
Window.ReSizeTo 320, 240


Class class_timer
	public	yobi,h,m,arg
	public	id,flag
	public	schedule_time
	public	count

	public function str
		str = yobi & " " & h & ":" & m & " " & arg
	end function

	public function schedule(genzai)
		schedule = dateValue(genzai)
		while cStr(weekdayName(weekday(schedule),true)) <> cStr(yobi)
			schedule = dateAdd("d",1,schedule)
			'msgbox schedule
		wend
		schedule = schedule & " " & h & ":" & m & ":00"
		'msgbox schedule
	end function

end Class

dim timer
set timer = new class_timer
timer.id = 0

dim cur
set cur = new class_timer

dim form
dim form_copy_flag
form_copy_flag = true

Sub start_OnClick	   'ƒOK„ÎŞÀİ‚ÌOnClick²ÍŞİÄÌßÛ¼°¼Ş¬  
	dim yobi, h, m, arg

	if form_copy_flag then
		Set form = Document.timerfrm		'µÌŞ¼Şª¸Ä‚ğ•Ï”‚ÉŠi”[
	end if
	form_copy_flag = true

	if timer.id > 0 then
		clearInterval(timer.id)
	end if

	timer.yobi = form.weekday.value
	timer.h = form.h.value
	timer.m = form.m.value
	timer.arg = form.arg.value
	timer.schedule_time = timer.schedule(now)

	form.time.value = timer.str
	write_time

	read_log()
	add_log(timer.str)

	timer.id = setInterval("Check_time", 2000)

End Sub



dim timer_log(10000), timer_c, timer_s
timer_c = 0
timer_s = 0

Sub call_log_OnClick
	if form_copy_flag then
		Set form = Document.timerfrm		'µÌŞ¼Şª¸Ä‚ğ•Ï”‚ÉŠi”[
	end if
	form_copy_flag = true
	read_log
	if timer_c > 0 then
		dim a
		a = timer_log(timer_s)
		form.weekday.value = left(a,1)
		form.h.value = mid(a,3,2)
		form.m.value = mid(a,6,2)
		form.arg.value = mid(a,9,20)
		form_copy_flag = false
		start_OnClick
		timer_s = timer_s - 1
		if timer_s <=0 then
			timer_s = timer_c
		end if
	end if
End sub

sub add_log(str)
	dim i
	for i=1 to timer_c
		if timer_log(i)=str then
			timer_s = i
			exit sub
		end if
	next
	timer_c = timer_c + 1
	timer_log(timer_c) = str
	timer_s = timer_c
	
	dim objFso, objFile
	Set objFso = CreateObject("Scripting.FileSystemObject")
	Set objFile = objFso.OpenTextFile("timer_log.txt", 2, True)

	for i=1 to timer_c
		objFile.WriteLine timer_log(i)
	next

	objFile.Close
	Set objFile = Nothing
	Set objFso = Nothing

end sub

dim read_log_flag
read_log_flag = true
sub read_log
	if read_log_flag then
		dim	objFso, objFile
		Set objFso = CreateObject("Scripting.FileSystemObject")

		If objFso.FileExists("timer_log.txt") Then
			Set objFile = objFso.OpenTextFile("timer_log.txt", 1, False)
			Do Until objFile.AtEndOfStream
				timer_c = timer_c + 1
				timer_log(timer_c) = objFile.ReadLine
			Loop
			timer_s = timer_c
			objFile.close
		End If

		set objFile = nothing
		Set objFso = Nothing
	end if
	read_log_flag = false
end sub


sub write_time
	dim cur_tmp
	cur_tmp=now
	cur.yobi=weekdayname(weekday(cur_tmp),true)
	cur.h=hour(cur_tmp)
	if cur.h < 10 then
		cur.h = "0" & cur.h
	end if
	cur.m=minute(cur_tmp)
	if cur.m < 10 then
		cur.m = "0" & cur.m
	end if
	cur.arg = ""
	form.now.value=cur.str
end sub

timer.flag=true

sub Check_time

	write_time
	dim wshell : set wshell = CreateObject("WScript.Shell")

	if cStr(timer.yobi)=cStr(cur.yobi) and cStr(timer.h)=cStr(cur.h) and cStr(timer.m)=cStr(cur.m) then
		if timer.flag then
			wshell.Run "NHK.hta " & timer.arg, 1, True
			timer.flag=false
			timer.schedule_time = timer.schedule(DateAdd("d",1,now))
		end if
	else
		timer.flag=true
		if datediff("n", now, timer.schedule_time) < 0 then
			timer.count = timer.count + 1
			if timer.count > 5 then
				wshell.Run "NHK.hta " & timer.arg, 1, True
				timer.flag=false
				timer.schedule_time = timer.schedule(DateAdd("d",1,now))
				timer.count = 0
			end if
		end if

	end if

end sub


-->
</script>
</head>
<body>
<FORM name="timerfrm">
	<select name="weekday">
		<option value="Œ">Œ</option>
		<option value="‰Î">‰Î</option>
		<option value="…">…</option>
		<option value="–Ø">–Ø</option>
		<option value="‹à">‹à</option>
		<option value="“y">“y</option>
		<option value="“ú">“ú</option>
	</select>
	<select name="h">
		<option value="00">00</option>
		<option value="01">01</option>
		<option value="02">02</option>
		<option value="03">03</option>
		<option value="04">04</option>
		<option value="05">05</option>
		<option value="06">06</option>
		<option value="07">07</option>
		<option value="08">08</option>
		<option value="09">09</option>
		<option value="10">10</option>
		<option value="11">11</option>
		<option value="12">12</option>
		<option value="13">13</option>
		<option value="14">14</option>
		<option value="15">15</option>
		<option value="16">16</option>
		<option value="17">17</option>
		<option value="18">18</option>
		<option value="19">19</option>
		<option value="20">20</option>
		<option value="21">21</option>
		<option value="22">22</option>
		<option value="23">23</option>
		<option value="24">24</option>
	</select>
	<select name="m">
		<option value="00">00•ª</option>
		<option value="05">05•ª</option>
		<option value="10">10•ª</option>
		<option value="15">15•ª</option>
		<option value="20">20•ª</option>
		<option value="25">25•ª</option>
		<option value="30">30•ª</option>
		<option value="35">35•ª</option>
		<option value="40">40•ª</option>
		<option value="45">45•ª</option>
		<option value="50">50•ª</option>
		<option value="55">55•ª</option>
	</select>
	<br>
	<select name="arg">
		<option value="-auto">-auto</option>
		<option value="-auto -autoexit">-auto -autoexit</option>
	</select>
	<INPUT type="button" value="Start" name="start"> 
	<br>
	<INPUT type="button" value="‰ß‹‚Ìİ’èª" name="call_log"> 
	<br>
	‹N“®
	<INPUT type="text" value="" name="time" style="color:#ff0000" size="26">
	<br>
	Œ»İ
	<INPUT type="text" value="" name="now" style="color:#0000ff" size="26">
</FORM>
</body>
</html>
